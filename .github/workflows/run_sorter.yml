name: Tube Sorter Manual Run

on:
  schedule:
    - cron: '0 18 * * *' # 매일 한국 시간 새벽 3시 (UTC 18:00) 실행
  workflow_dispatch:
    inputs:
      max_process_count:
        description: 'Number of videos to process (optional, overrides variable)'
        required: false
        default: ''
      reset_state:
        description: 'Reset state and start from the beginning? (true/false)'
        required: false
        default: 'false'

jobs:
  run-sorter:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 저장소에 푸시하기 위해 필요한 쓰기 권한

    steps:
      - name: Checkout code (Logic)
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Fetch persistent state (Read)
        run: |
          if [ "${{ github.event.inputs.reset_state }}" = "true" ]; then
            echo '{"last_published_at": "1970-01-01T00:00:00Z"}' > state.json
            echo "State reset requested. Starting from the beginning."
          else
            # 원격의 state-tracking 브랜치에서 최신 state.json만 가져옴
            git fetch origin state-tracking || true
            git checkout origin/state-tracking -- state.json || echo '{"last_published_at": "1970-01-01T00:00:00Z"}' > state.json
            echo "Current state loaded:"
            cat state.json
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup environment and secrets
        env:
          CLIENT_SECRETS_JSON: ${{ secrets.CLIENT_SECRETS_JSON }}
          TOKEN_JSON: ${{ secrets.TOKEN_JSON }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
          REPO_MAX_COUNT: ${{ vars.MAX_PROCESS_COUNT }}
          INPUT_MAX_COUNT: ${{ github.event.inputs.max_process_count }}
        run: |
          # 환경 변수를 통해 안전하게 파일 생성
          echo "$CLIENT_SECRETS_JSON" > client_secrets.json
          echo "$TOKEN_JSON" > token.json
          echo "$ENV_FILE" > .env
          
          # 우선순위 결정: 수동 입력 > 저장소 변수 > .env 기본값
          FINAL_COUNT=""
          if [ -n "$INPUT_MAX_COUNT" ]; then
            FINAL_COUNT=$INPUT_MAX_COUNT
            echo "Using manual input count: $FINAL_COUNT"
          elif [ -n "$REPO_MAX_COUNT" ]; then
            FINAL_COUNT=$REPO_MAX_COUNT
            echo "Using repository variable count: $FINAL_COUNT"
          fi

          if [ -n "$FINAL_COUNT" ]; then
            sed -i "s/^MAX_PROCESS_COUNT=.*/MAX_PROCESS_COUNT=$FINAL_COUNT/" .env
          fi

      - name: Run Sorter
        run: |
          PYTHONPATH=. python sorter.py

      - name: Persist state (Write)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # state.json이 있을 때만 안전하게 보관 및 업데이트를 진행합니다.
          if [ -f state.json ]; then
            cp state.json state.json.tmp
            
            # 임시 브랜치를 만들어 히스토리를 끊습니다.
            git checkout --orphan temp-state
            
            # 인덱스와 작업 디렉토리의 모든 파일을 비웁니다.
            git rm -rf .
            
            # 복사해둔 파일을 다시 가져옵니다.
            mv state.json.tmp state.json
            
            # state.json만 추가하고 커밋합니다.
            git add state.json
            git commit -m "chore: update state.json [skip ci]"
            
            # state-tracking 브랜치로 강제 푸시하여 최신 상태 유지
            git push origin temp-state:state-tracking --force
          else
            echo "No state.json found to persist. Skipping state update."
          fi
